# Source: https://workshops.modular.com/3_hands_on/vectorization_parallelization_mojo/

from tensor import Tensor, TensorShape, TensorSpec
from math import trunc
from memory import memset_zero
from sys.info import simdwidthof, simdbitwidth
from algorithm import vectorize, parallelize
from utils.index import Index
from random import rand, seed
from python import Python
import time

alias dtype = DType.float32
alias simd_width: Int = simdwidthof[dtype]()

fn tensor_add[dtype: DType](mut t1: Tensor[dtype], t2: Tensor[dtype]) -> Tensor[dtype]:
    for i in range(t1.dim(0)):
        for j in range(t1.dim(1)):
            t1[Index(i,j)] += t2[Index(i, j)]
            
    return t1
    
fn tensor_add_parallelized_vectorized[dtype: DType](mut t1: Tensor[dtype], t2: Tensor[dtype]) -> Tensor[dtype]:
    @parameter
    fn parallelize_rows(idx: Int) -> None:
        @parameter
        fn vectorized_add[simd_width: Int](idx2: Int) -> None:
            #var vec1 = t1._ptr.load[width=simd_width](idx * t1.dim(1) + idx2)
            #var vec2 = t2._ptr.load[width=simd_width](idx * t2.dim(1) + idx2)
            t1._ptr.store(idx * t1.dim(1) + idx2, t1._ptr.load[width=simd_width](idx * t1.dim(1) + idx2) + t2._ptr.load[width=simd_width](idx * t2.dim(1) + idx2))
        
        vectorize[vectorized_add, simd_width](t1.dim(1))

    parallelize[parallelize_rows](t1.dim(0), simd_width)
    return t1

def main():
    print("SIMD bit width",simdbitwidth())
    print("SIMD Width",simd_width)
    
    seed(42)
    var t1 = Tensor[dtype].rand(TensorShape(3000, 20000))
    var t2 = Tensor[dtype].rand(TensorShape(3000, 20000))
    
    var time = Python.import_module("time")
    
    var tm1 = time.time()
    var sum = tensor_add(t1, t2)
    var dur1 = time.time()-tm1
    
    print("\nNaive Tensor Addition")
    print(sum)

    var tm2 = time.time()
    
    var sum2 = tensor_add_parallelized_vectorized[dtype](t1, t2)
    
    var dur2 = time.time()-tm2
    
    print("\nParallelized and Vectorized Tensor Addition")
    print(sum2)

    print("")
    print("Mojo naive addition:",dur1,"seconds")
    print("Mojo vecotorized addition:",dur2,"seconds")
